<!doctype html>
<html lang="en">
<meta charset="utf-8">
<head>
  <div id="cssplaceholder"></div>
  <script src="3rdscripts/markdown-it/markdown-it.min.js"></script>
  <script src="3rdscripts/markdown-it/markdown-it-emoji.min.js"></script>
  <script src="3rdscripts/markdown-it/markdown-it-footnote.min.js"></script>
 
  <script src="3rdscripts/math/katex.min.js"></script>
  <link  rel="stylesheet" href="3rdscripts/math/katex.min.css">
  <script src="3rdscripts/math/texmath.min.js"></script>
  <link  rel="stylesheet" href="3rdscripts/math/texmath.min.css">

  <script src="3rdscripts/highlight/highlight.min.js"></script>
  <link rel="stylesheet" href="3rdscripts/highlight/default.min.css">

  <script src="3rdscripts/mermaid.min.js"></script>


  <script src="qrc:/qtwebchannel/qwebchannel.js"></script>

  <script>
  function setMdTheme(theme) {
    if (theme == 'none')
      document.getElementById('cssplaceholder').innerHTML = '';
    else
      document.getElementById('cssplaceholder').innerHTML = '<link rel=\"stylesheet\" type=\"text/css\" href=\"themes/' + theme + '.css\">';
  }
  </script>
</head>
<body>
  <div id="place3434holder">
   
</div>
  <div id="placeholder"><pre>
   <code class="language-mermaid">
   <div class="mermaid">graph TD;
    A-->B;
    A-->C;
    B-->D;
    C-->D;
  </div>
  </code>
  </pre></div>
  <script>
  'use strict';

  var placeholder = document.getElementById('placeholder');

  var updateText = function(text) {
         var defaults = {
            html: false,                // Enable HTML tags in source
            xhtmlOut: false,            // Use '/' to close single tags (<br />)
            breaks: false,              // Convert '\n' in paragraphs into <br>
            langPrefix: 'language-',    // CSS language prefix for fenced blocks
            linkify: true,              // autoconvert URL-like texts to links
            typographer: true,          // Enable smartypants and other sweet transforms
          }; 

     // 参考 https://github.com/yansenlei/markdown-it-mermaid
     const mermaidChart = (code) => {
        try {
         // mermaid.parse(code)
         // return `<div class="mermaid">${code}</div>`
         var needsUniqueId = "render" + (Math.floor(Math.random() * 10000)).toString();
         mermaid.mermaidAPI.render(needsUniqueId, code, sc => {code=sc})
         return `<div class="mermaid">${code}</div>`
        } catch ({ str, hash }) {
          return `<pre>${str}</pre>`
        }
     }

     defaults.highlight = function (str, lang) {
                    //console.log(str);console.log(lang);
                    var esc = md.utils.escapeHtml;
                    if (lang && hljs.getLanguage(lang)) {
                          try {
                            return '<pre class="hljs"><code>' +
                                           hljs.highlight(lang, str, true).value +
                                           '</code></pre>';
                          } catch (__) {}
                    } else if (lang == 'mermaid') {
                          return mermaidChart(str)
                    } else {
                          return '<pre class="hljs"><code>' + esc(str) + '</code></pre>';
                    }
                  };
      
      

      var md = window.markdownit(defaults).use(window.markdownitEmoji)
                                          .use(window.markdownitFootnote)
                                          .use(texmath, { engine: katex,
                                                          delimiters: 'dollars',
                                                          katexOptions: { macros: {"\\RR": "\\mathbb{R}"} } } );
      placeholder.innerHTML =  md.render(text);
	  mermaid.initialize({startOnLoad:true});
  }


  new QWebChannel(qt.webChannelTransport,
    function(channel) {
      var content = channel.objects.content;
      updateText(content.text);
      content.textChanged.connect(updateText);
    }
  );
  </script>

</body>
</html>



